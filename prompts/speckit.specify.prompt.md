---
agent: speckit.specify
---
## Jira Integration Instructions

These instructions apply **only when the user input contains a Jira story key** (e.g., `FOOD-123`, `ORD-42`). The agent detects this automatically — no manual flag is needed.

### Jira Configuration

All Jira operations use the **Atlassian MCP tools** — no API tokens or environment variables needed. The MCP server handles authentication via the configured connection in `.vscode/mcp.json`.

---

### Step J0 — Resolve Cloud ID

Before any Jira operation, obtain the `cloudId` for the workspace:

- Use tool: `mcp_atlassian_getAccessibleAtlassianResources`
- Extract the `cloudId` from the response — pass it to every subsequent Jira tool call
- Cache it for the session; only call this once per agent run

---

### Step J1 — Fetch the Jira Story

When input contains a Jira key:

1. Use tool: `mcp_atlassian_getJiraIssue`
   - Parameters: `cloudId`, `issueIdOrKey: {JIRA_KEY}`
   - Request these fields: `summary`, `description`, `labels`, `priority`, `assignee`, `comment`

2. Extract from the response:
   - `fields.summary` → use as the feature description (replaces free-text `$ARGUMENTS`)
   - `fields.description` → treat as additional context and acceptance criteria
   - `fields.labels`, `fields.priority`, `fields.assignee` → include in spec Assumptions section
   - `fields.comment.comments` → scan for previous AI-generated comments (identified by body text starting with `## AI Impact Analysis` or `## AI Specification`). If found:
     - **Impact analysis comment found** → pre-load it, skip re-analysis unless user explicitly requests it (see Step J3)
     - **Spec comment found** → inform user a spec was previously generated and ask if they want to regenerate or update it

3. Use `fields.summary` as the feature description for branch naming and all subsequent steps.

---

### Step J2 — Branch Naming for Jira Stories

Prefix the branch short-name with the Jira key:

```
{JIRA_KEY}-{short-name}
```

Examples:
- `FOOD-123` + `"add user auth"` → `FOOD-123-user-auth`
- `ORD-42` + `"fix payment timeout"` → `ORD-42-fix-payment-timeout`

This ensures the branch is always traceable back to the Jira ticket.

---

### Step J3 — Impact Analysis Decision

When a Jira key is provided on **subsequent invocations** (i.e., an impact analysis comment already exists on the story):

- **If user explicitly says** `"do impact analysis"` or `"re-run impact analysis"` → run the full impact analysis (agent Step 1) and post a fresh comment to Jira
- **Otherwise** → skip impact analysis entirely and proceed directly to **Step 4** (load template and write spec), using the previously posted impact analysis as context

On **first invocation** (no prior comment found): always run the full impact analysis.

---

### Step J4 — Post Impact Analysis as Jira Comment

After the impact analysis file is written (`FEATURE_DIR/impact-analysis.md`) and before asking the user `continue / later`:

1. Format the comment body in Markdown:

   ```
   ## AI Impact Analysis
   > Auto-generated by speckit.specify on {DATE}. Review before proceeding.

   **Recommendation**: {Recommendation value from impact-analysis.md}

   ### Overlapping / Related Specs
   {table content}

   ### Affected Areas
   {table content}

   ### Risks & Dependencies
   {table content}

   ### Notes
   {Notes section content, if any}
   ```

2. Use tool: `mcp_atlassian_addCommentToJiraIssue`
   - Parameters: `cloudId`, `issueIdOrKey: {JIRA_KEY}`, `commentBody: {formatted markdown above}`

3. Confirm to the user: `"Impact analysis posted to {JIRA_KEY}."`

---

### Step J5 — Post Spec as Jira Comment

After the specification passes quality validation (agent Step 7) and is complete:

1. Read the written `spec.md` content
2. Format the comment in Markdown:

   ```
   ## AI Specification
   > Auto-generated by speckit.specify on {DATE}. Pending review and planning.

   {Full spec.md content}
   ```

3. Use tool: `mcp_atlassian_addCommentToJiraIssue`
   - Parameters: `cloudId`, `issueIdOrKey: {JIRA_KEY}`, `commentBody: {formatted markdown above}`

4. Confirm to the user: `"Specification posted to {JIRA_KEY}. The story now has the full spec as a comment for team review."`

> **Note**: If a previous `## AI Specification` comment already exists, always add a **new** comment — do not attempt to edit the old one. Jira's comment history provides the audit trail.

---

### Jira Error Handling

| Scenario | Action |
|----------|--------|
| `mcp_atlassian_getAccessibleAtlassianResources` returns no results | Warn user: "No Atlassian workspace found. Falling back to free-text mode." Proceed without Jira integration. |
| `mcp_atlassian_getJiraIssue` returns not found | Stop: "Story {JIRA_KEY} not found. Check the key and try again." |
| `mcp_atlassian_addCommentToJiraIssue` fails | Warn user but do not fail the whole flow — local files are already saved. |
| Story already has both impact + spec comments | Inform user both already exist and ask: "Re-generate impact analysis, re-generate spec, or skip?" |